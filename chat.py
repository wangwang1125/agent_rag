import os
import logging
import warnings
from openai import OpenAI
from llama_index.core import StorageContext,load_index_from_storage,Settings
from llama_index.embeddings.dashscope import (
    DashScopeEmbedding,
    DashScopeTextEmbeddingModels,
    DashScopeTextEmbeddingType,
)
from llama_index.postprocessor.dashscope_rerank import DashScopeRerank
from create_kb import *

# å¯¼å…¥å¤šæ™ºèƒ½ä½“ç›¸å…³æ¨¡å—
from dashscope import Assistants, Messages, Runs, Threads
import dashscope
import json
import ast
from tools import MedicalAnalysis

# ç¦ç”¨DashScopeå’Œç›¸å…³åº“çš„æ—¥å¿—è¾“å‡º
logging.getLogger('dashscope').setLevel(logging.ERROR)
logging.getLogger('openai').setLevel(logging.ERROR)
logging.getLogger('httpx').setLevel(logging.ERROR)
logging.getLogger('httpcore').setLevel(logging.ERROR)
logging.getLogger('requests').setLevel(logging.ERROR)
logging.getLogger('urllib3').setLevel(logging.ERROR)

# ç¦ç”¨æ‰€æœ‰è­¦å‘Š
warnings.filterwarnings('ignore')

# è®¾ç½®æ ¹æ—¥å¿—çº§åˆ«ä¸ºWARNINGï¼Œé¿å…è°ƒè¯•ä¿¡æ¯è¾“å‡º
logging.basicConfig(level=logging.WARNING)

# å…¨å±€è¿‡æ»¤DashScopeè°ƒè¯•è¾“å‡ºçš„è§£å†³æ–¹æ¡ˆ
import sys
import contextlib

class DashScopeOutputFilter:
    """å…¨å±€è¿‡æ»¤DashScope JSONè°ƒè¯•è¾“å‡ºçš„ç±»"""
    def __init__(self, original_stdout, original_stderr):
        self.original_stdout = original_stdout
        self.original_stderr = original_stderr
        self.suppress_next_newlines = False  # æ ‡è®°æ˜¯å¦éœ€è¦æŠ‘åˆ¶åç»­çš„æ¢è¡Œ
        
    def write(self, text):
        if text and isinstance(text, str):
            # è¿‡æ»¤DashScopeçš„JSONè°ƒè¯•è¾“å‡º
            text_lower = text.lower()
            if (text.strip().startswith('{') and 
                any(keyword in text for keyword in ['assistant_id', 'thread_id', 'run_id', 'object": "thread.run'])):
                self.suppress_next_newlines = True  # è®¾ç½®æ ‡è®°ï¼ŒæŠ‘åˆ¶åç»­æ¢è¡Œ
                return  # ä¸è¾“å‡º
            if any(keyword in text_lower for keyword in [
                'status_code', 'request_id', 'created_at', 'instructions'
            ]) and text.strip().startswith('{'):
                self.suppress_next_newlines = True  # è®¾ç½®æ ‡è®°ï¼ŒæŠ‘åˆ¶åç»­æ¢è¡Œ
                return  # ä¸è¾“å‡º
            
            # å¦‚æœå½“å‰åœ¨æŠ‘åˆ¶æ¨¡å¼ï¼Œä¸”æ–‡æœ¬åªåŒ…å«ç©ºç™½å­—ç¬¦ï¼ˆæ¢è¡Œç¬¦ã€ç©ºæ ¼ç­‰ï¼‰ï¼Œåˆ™ä¸è¾“å‡º
            if self.suppress_next_newlines:
                if text.strip() == '':  # åªåŒ…å«ç©ºç™½å­—ç¬¦
                    return  # ä¸è¾“å‡ºç©ºç™½è¡Œ
                else:
                    # é‡åˆ°éç©ºç™½å†…å®¹ï¼Œå–æ¶ˆæŠ‘åˆ¶æ¨¡å¼
                    self.suppress_next_newlines = False
                    
        # è¾“å‡ºåˆ°åŸå§‹stdout
        self.original_stdout.write(text)
        
    def flush(self):
        self.original_stdout.flush()

# åº”ç”¨å…¨å±€è¿‡æ»¤å™¨
original_stdout = sys.stdout
original_stderr = sys.stderr
sys.stdout = DashScopeOutputFilter(original_stdout, original_stderr)

# è®¾ç½®DashScope APIå¯†é’¥
dashscope.api_key = "sk-51d30a5436ca433b8ff81e624a23dcac"

# è¿›ä¸€æ­¥æ§åˆ¶DashScopeè¾“å‡º - è®¾ç½®ç¯å¢ƒå˜é‡
os.environ['DASHSCOPE_DEBUG'] = 'false'
os.environ['DASHSCOPE_VERBOSE'] = 'false'
os.environ['OPENAI_LOG_LEVEL'] = 'error'

# å¦‚æœDashScopeæœ‰é…ç½®é€‰é¡¹ï¼Œè®¾ç½®ä¸ºé™é»˜æ¨¡å¼
try:
    dashscope.api_base = dashscope.api_base  # ä¿æŒé»˜è®¤å€¼
    # å°è¯•è®¾ç½®è°ƒè¯•æ¨¡å¼ä¸ºFalseï¼ˆå¦‚æœæ”¯æŒï¼‰
    if hasattr(dashscope, 'debug'):
        dashscope.debug = False
    if hasattr(dashscope, 'verbose'):
        dashscope.verbose = False
except:
    pass

DB_PATH = "VectorStore"
TMP_NAME = "tmp_abcd"
EMBED_MODEL = DashScopeEmbedding(
    model_name=DashScopeTextEmbeddingModels.TEXT_EMBEDDING_V2,
    text_type=DashScopeTextEmbeddingType.TEXT_TYPE_DOCUMENT,
    api_key="sk-51d30a5436ca433b8ff81e624a23dcac",
)
# è‹¥ä½¿ç”¨æœ¬åœ°åµŒå…¥æ¨¡å‹ï¼Œè¯·å–æ¶ˆä»¥ä¸‹æ³¨é‡Šï¼š
# from langchain_community.embeddings import ModelScopeEmbeddings
# from llama_index.embeddings.langchain import LangchainEmbedding
# embeddings = ModelScopeEmbeddings(model_id="modelscope/iic/nlp_gte_sentence-embedding_chinese-large")
# EMBED_MODEL = LangchainEmbedding(embeddings)

# è®¾ç½®åµŒå…¥æ¨¡å‹
Settings.embed_model = EMBED_MODEL

# ==================== å†³ç­–æ ‘å®šä¹‰ ====================

decision_tree = """
{
    "ä½“æˆåˆ†": {
        "ä½“é‡åä½": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "BMI < 18.5 ä¸”ï¼ˆå¥³æ€§å»è„‚ä½“é‡æŒ‡æ•° â‰¥ 15 æˆ–ç”·æ€§å»è„‚ä½“é‡æŒ‡æ•° â‰¥ 17ï¼‰"
            ]
        },
        "æ¶ˆç˜¦": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "BMI < 18.5 ä¸”ï¼ˆå¥³æ€§å»è„‚ä½“é‡æŒ‡æ•° < 15 æˆ– ç”·æ€§å»è„‚ä½“é‡æŒ‡æ•° < 17ï¼‰"
            ]
        },
        "è‚Œè‚‰è¿‡å°‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "BMI > 18.5 ä¸”ï¼ˆå¥³æ€§å»è„‚ä½“é‡æŒ‡æ•° < 15 æˆ– ç”·æ€§å»è„‚ä½“é‡æŒ‡æ•° < 17ï¼‰",
                "BMI â‰¥ 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼šâ‰¥ 30ï¼‰ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ â‰¥ 30% æˆ– ç”·æ€§ â‰¥ 25%ï¼‰ä¸” åŒä¾§å°è…¿å›´ï¼ˆå¥³æ€§ < 33cm æˆ– ç”·æ€§ < 34cmï¼‰",
                "BMI â‰¥ 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼šâ‰¥ 30ï¼‰ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ â‰¥ 30% æˆ– ç”·æ€§ â‰¥ 25%ï¼‰ä¸” å»è„‚ä½“é‡æŒ‡æ•°ï¼ˆå¥³æ€§ < 15 æˆ– ç”·æ€§ < 17ï¼‰"
            ]
        },
        "ä¸­å¿ƒæ€§è‚¥èƒ–": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "18.5 < BMI < 27.9ï¼ˆæµ·å¤–æ ‡å‡†ï¼š< 30ï¼‰ä¸” è…°è‡€æ¯”ï¼šä¸­å›½ä»¥å¤–åœ°åŒºï¼šç”·æ€§ > 1.0 æˆ– å¥³æ€§ > 0.9 ä¸­å›½åœ°åŒºï¼šç”·æ€§ > 0.9 æˆ– å¥³æ€§ > 0.85",
                "18.5 < BMI < 27.9ï¼ˆæµ·å¤–æ ‡å‡†ï¼š< 30ï¼‰ä¸” è…°å›´ï¼ˆå¥³æ€§ â‰¥ 80cm æˆ– ç”·æ€§ â‰¥ 85cmï¼Œæµ·å¤–ç”·æ€§ â‰¥ 90cmï¼‰ä¸” å†…è„è„‚è‚ªç­‰çº§ â‰¥ 10"
            ]
        },
        "è‚¥èƒ–": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "BMI â‰¥ 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼šâ‰¥ 30ï¼‰ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ â‰¥ 30% æˆ– ç”·æ€§ â‰¥ 25%ï¼‰"
            ]
        },
        "å°‘è‚Œæ€§è‚¥èƒ–": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "BMI â‰¥ 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼šâ‰¥ 30ï¼‰ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ â‰¥ 30% æˆ– ç”·æ€§ â‰¥ 25%ï¼‰ä¸” åŒä¾§å°è…¿å›´ï¼ˆå¥³æ€§ < 33cm æˆ– ç”·æ€§ < 34cmï¼‰",
                "BMI â‰¥ 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼šâ‰¥ 30ï¼‰ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ â‰¥ 30% æˆ– ç”·æ€§ â‰¥ 25%ï¼‰ä¸” å»è„‚ä½“é‡æŒ‡æ•°ï¼ˆå¥³æ€§ < 15 æˆ– ç”·æ€§ < 17ï¼‰"
            ]
        },
        "ä½“é‡æ­£å¸¸": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "18.5 â‰¤ BMI < 24ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ < 30% ä¸” ç”·æ€§ < 25%ï¼‰ä¸”ï¼ˆè…°å›´ï¼šå¥³æ€§ < 80cm ä¸” ç”·æ€§ < 85cmï¼Œæµ·å¤–ç”·æ€§ < 90cmï¼‰æˆ– å†…è„è„‚è‚ªç­‰çº§ < 10"
            ]
        },
        "è¶…é‡": {
            "ä¼˜å…ˆçº§": 4,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "24 â‰¤ BMI < 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼š< 30ï¼‰ä¸”ï¼ˆä½“è„‚ç‡ï¼šå¥³æ€§ 25%-30% æˆ– ç”·æ€§ 20%-25%ï¼‰æˆ–ï¼ˆè…°å›´ï¼šå¥³æ€§ 77-80cm æˆ– ç”·æ€§ 80-85cm ä¸” 8 â‰¤ å†…è„è„‚è‚ªç­‰çº§ < 10ï¼‰"
            ]
        },
        "è‚Œè‚‰å‘è¾¾": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "24 â‰¤ BMI < 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼š< 30ï¼‰ä¸” å»è„‚ä½“é‡æŒ‡æ•°ï¼ˆç”·æ€§ â‰¥ 20 æˆ– å¥³æ€§ â‰¥ 18ï¼‰ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ < 25% ä¸” ç”·æ€§ < 20%ï¼‰ä¸”ï¼ˆè…°å›´å¥³æ€§ < 77cm ä¸” ç”·æ€§ < 80cmæˆ– å†…è„è„‚è‚ªç­‰çº§ < 8æˆ– è…°è‡€æ¯”ï¼šç”·æ€§ < 0.9 ï¼Œå¥³æ€§ < 0.8ï¼ˆæµ·å¤–ï¼šç”·æ€§ < 0.9 ä¸” å¥³æ€§ < 0.85ï¼‰ï¼‰"
            ]
        },
        "å¥åº·é£é™©å¢åŠ ": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "18.5 â‰¤ BMI < 24ä¸” ä½“è„‚ç‡ï¼ˆå¥³æ€§ < 30% ä¸” ç”·æ€§ < 25%ï¼‰ä¸”ï¼ˆè…°å›´ï¼šå¥³æ€§ < 80cm ä¸” ç”·æ€§ < 85cmï¼Œæµ·å¤–ç”·æ€§ < 90cmï¼‰æˆ– å†…è„è„‚è‚ªç­‰çº§ < 10 ä¸” å­˜åœ¨ä»¥ä¸‹ä»»ä¸€é£é™©æŒ‡æ ‡ï¼šé¢ˆå›´ï¼šç”·æ€§ > 43cm æˆ– å¥³æ€§ > 41cmæˆ– ç»†èƒå¤–æ¶²/æ€»æ°´åˆ† â‰¥ 0.4æˆ– ç»†èƒå¤–æ¶²/ç»†èƒå†…æ¶² â‰¤ 0.57",
                "24 â‰¤ BMI < 28ï¼ˆæµ·å¤–æ ‡å‡†ï¼š< 30ï¼‰ä¸”ï¼ˆä½“è„‚ç‡ï¼šå¥³æ€§ 25%-30% æˆ– ç”·æ€§ 20%-25%ï¼‰æˆ–ï¼ˆè…°å›´ï¼šå¥³æ€§ 77-80cm æˆ– ç”·æ€§ 80-85cmä¸” 8 â‰¤ å†…è„è„‚è‚ªç­‰çº§ < 10ï¼‰ä¸” å­˜åœ¨ä»¥ä¸‹ä»»ä¸€é£é™©æŒ‡æ ‡ï¼šé¢ˆå›´ï¼šç”·æ€§ > 43cm æˆ– å¥³æ€§ > 41cmæˆ– ç»†èƒå¤–æ¶²/æ€»æ°´åˆ† â‰¥ 0.4æˆ– ç»†èƒå¤–æ¶²/ç»†èƒå†…æ¶² â‰¤ 0.57"
            ]
        }
    },
    "ä½“æ€": {
        "å¯èƒ½éª¨ç›†æ—‹ç§»": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "éª¨ç›†å‰ç§»è§’åº¦â‰¤179æˆ–éª¨ç›†å‰ç§»è·ç¦»â‰¥2cmä¸”åŒä¾§è†å…³èŠ‚è§’åº¦å·®å¼‚ç›¸å·®â‰¥5Â°ã€‚åŒæ—¶è¾ƒå¤§è…¿å‹è§’åº¦ä¸€ä¾§çš„è†å…³èŠ‚è§’åº¦æ¯”è¾ƒå°è†å…³èŠ‚ä¸€ä¾§è…¿å‹è§’åº¦å¤š3"
            ]
        },
        "å¯èƒ½éª¨ç›†å‰ç§»": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "éª¨ç›†å‰ç§»è§’åº¦â‰¤179æˆ–éª¨ç›†å‰ç§»è·ç¦»>2cmä¸”åŒä¾§è†å…³èŠ‚è§’åº¦â‰¥181"
            ]
        },
        "å¯èƒ½éª¨ç›†å‰å€¾": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "éª¨ç›†å‰ç§»è§’åº¦>179æˆ–éª¨ç›†å‰ç§»è·ç¦»â‰¤2cmä¸”åŒä¾§è†å…³èŠ‚è§’åº¦>184Â°ä¸”åŒä¾§è…¿å‹è§’åº¦<179"
            ]
        },
        "å¯èƒ½éª¨ç›†åå€¾": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "éª¨ç›†å‰ç§»è§’åº¦>179æˆ–éª¨ç›†å‰ç§»è·ç¦»â‰¤2cmä¸”åŒä¾§è†å…³èŠ‚è§’åº¦<179Â°ä¸”åŒä¾§è…¿å‹è§’åº¦>181"
            ]
        },
        "éª¨ç›†æ—‹ç§»ä¸”å¯èƒ½è¯±å‘è‚©å…³èŠ‚æ´»åŠ¨å—é™": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "éª¨ç›†å‰ç§»è§’åº¦â‰¤179æˆ–éª¨ç›†å‰ç§»è·ç¦»â‰¥2cmä¸”åŒä¾§è†å…³èŠ‚è§’åº¦å·®å¼‚ç›¸å·®â‰¥5Â°ã€‚åŒæ—¶è¾ƒå¤§è…¿å‹è§’åº¦ä¸€ä¾§çš„è†å…³èŠ‚è§’åº¦æ¯”è¾ƒå°è†å…³èŠ‚ä¸€ä¾§è…¿å‹è§’åº¦å¤š3ä¸”è†å…³èŠ‚è§’åº¦è¾ƒå¤§ä¸€ä¾§è‚©éƒ¨å‰ä¼¸ä¸Šä¸¾ä¸Šä¸¾å°äº<175Â°"
            ]
        },
        "éª¨ç›†æ—‹ç§»ä¸”å¯èƒ½è¯±å‘å¤´ä¾§æ­ª": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "éª¨ç›†å‰ç§»è§’åº¦â‰¤179æˆ–éª¨ç›†å‰ç§»è·ç¦»â‰¥2cmä¸”åŒä¾§è†å…³èŠ‚è§’åº¦å·®å¼‚ç›¸å·®â‰¥5Â°ã€‚åŒæ—¶è¾ƒå¤§è…¿å‹è§’åº¦ä¸€ä¾§çš„è†å…³èŠ‚è§’åº¦æ¯”è¾ƒå°è†å…³èŠ‚ä¸€ä¾§è…¿å‹è§’åº¦å¤š3ä¸”å¤´ä¾§æ­ªæœå‘ä¸ºè¾ƒå°è†å…³èŠ‚è§’åº¦ä¸€ä¾§"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±å¤´ä¾§æ­ªè¯±å‘çš„": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                ""
            ]
        },
        "ï¼ˆå¤´æ­ªä¾§/é«˜è‚©ä¸€ä¾§ï¼‰æ–œæ–¹è‚Œå’Œè‚©èƒ›æè‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 6,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ï¼ˆå¤´æ­ªä¾§ï¼‰ä¸”å­˜åœ¨é«˜ä½è‚©ï¼ˆé«˜è‚©ä¾§ï¼‰ï¼Œå¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸å"
            ]
        },
        "é«˜è‚©ä¾§ ä¸Šæ–œæ–¹è‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 6,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´å‰å¼•ä¸”å­˜åœ¨é«˜ä½è‚©ï¼ˆé«˜è‚©ä¾§ï¼‰"
            ]
        },
        "å¤´ä¾§æ­ªä¾§è‚©èƒ›æè‚Œã€å¤´ä¾§æ­ªä¾§æ–œè§’è‚Œã€é«˜è‚©ä¾§ä¸Šæ–œæ–¹è‚Œç´§å¼ ã€å¤´ä¾§æ­ªçš„å¯¹ä¾§ èƒ¸é”ä¹³çªè‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 6,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´å‰å¼•ã€å­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ï¼ˆå¤´æ­ªä¾§ï¼‰ä¸”å­˜åœ¨é«˜ä½è‚©ï¼ˆé«˜è‚©ä¾§ï¼‰ï¼Œå¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸åï¼ˆå¯¹ä¾§å…³ç³»ï¼‰"
            ]
        },
        "å¤´ä¾§æ­ªä¾§æ–œè§’è‚Œç´§å¼ ã€å¯¹ä¾§èƒ¸é”ä¹³çªè‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 6,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å¤´æ­ªå‘ä¸€ä¾§ï¼ˆå¤´æ­ªä¾§ï¼‰ã€é«˜ä½è‚©ï¼ˆé«˜è‚©ä¾§ï¼‰ã€åœ†è‚©ï¼ˆåœ†è‚©ä¾§ï¼‰åŠå¤´å‰å¼•è¿™å››é¡¹ä¸­è‡³å°‘ä¸¤é¡¹åŒæ—¶å­˜åœ¨ï¼Œä¸”è¿™äº›ç—‡çŠ¶å‡ºç°åœ¨èº«ä½“åŒä¾§"
            ]
        },
        "ä¸”å‰é”¯è‚Œç´§å¼ ã€ä¸‰è§’è‚Œå‰æŸã€å†ˆä¸Šè‚Œã€ä¸‹æ–œæ–¹è‚Œæ— åŠ›": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´ä¾§æ­ªæˆ–é«˜ä½è‚©ä¸”ï¼ˆå¤´æ­ªä¾§/é«˜è‚©ä¸€ä¾§)æ–œæ–¹è‚Œå’Œè‚©èƒ›æè‚Œç´§å¼ ä¸”å¤´æ­ªä¾§æˆ–é«˜è‚©ä¾§è‚©éƒ¨å¤–å±•ä¸Šä¸¾å°äº175Â°"
            ]
        },
        "ä¸”ä¸‰è§’è‚Œä¸­æŸå’ŒåæŸæ— åŠ›": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´ä¾§æ­ªæˆ–é«˜ä½è‚©ä¸”ï¼ˆå¤´æ­ªä¾§/é«˜è‚©ä¸€ä¾§)æ–œæ–¹è‚Œå’Œè‚©èƒ›æè‚Œç´§å¼ ä¸”å¤´æ­ªä¾§æˆ–é«˜è‚©ä¸€ä¾§å‰ä¼¸ä¸Šä¸¾å°äº175"
            ]
        },
        "ä¸” å‰é”¯è‚Œç´§å¼ ã€ä¸‰è§’è‚Œå‰/ä¸­/åæŸã€å†ˆä¸Šè‚Œã€ä¸‹æ–œæ–¹è‚Œæ— åŠ›": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å‰é”¯è‚Œç´§å¼ ã€ä¸‰è§’è‚Œå‰æŸã€ç½‘ä¸Šè‚Œã€ä¸‹æ–œæ–¹è‚Œæ— åŠ›ä¸”ä¸‰è§’è‚Œä¸­/åæŸæ— åŠ›"
            ]
        },
        "å¯èƒ½å­˜åœ¨å•ä¾§è¶³å¼“å¡Œé™·": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é«˜ä½è‚©ï¼Œå¹¶ä¸”å­˜åœ¨å¤´ä¾§æ­ªã€å¤´å‰å¼•æˆ–åœ†è‚©ä¸­è‡³å°‘ä¸€é¡¹ï¼Œå¹¶ä¸”å¤´ä¾§æ­ªæœå‘é«˜è‚©ä¾§ï¼Œå¹¶ä¸”ä½è‚©ä¸€ä¾§è…¿å‹è§’åº¦â‰¥180ï¼Œç™¾é«˜è‚©ä¸€ä¾§è…¿å‹è§’åº¦â‰¤179"
            ]
        },
        "å¤´ä¾§æ­ªå’Œï¼ˆæˆ–ï¼‰å¤´å‰å¼•å’Œï¼ˆæˆ–ï¼‰é«˜ä½è‚©æ˜¯ä¸€ä¸ªé—®é¢˜è¯±å‘": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "ä½è‚©ä¸€ä¾§è…¿å‹è§’åº¦â‰¥180ï¼Œç™¾é«˜è‚©ä¸€ä¾§è…¿å‹è§’åº¦â‰¤179"
            ]
        },
        "å¤´ä¾§æ­ª/é«˜ä½è‚©/å¤´å‰å¼• å‡ç”±éª¨ç›†æ—‹ç§»è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”å­˜åœ¨å¤´æ­ªã€å¤´å‰å¼•æˆ–åœ†è‚©ä¸­è‡³å°‘ä¸€é¡¹ï¼Œä¸”ï¼ˆå­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ä¸”å­˜åœ¨é«˜ä½è‚©å¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸åï¼Œæˆ–å­˜åœ¨å¤´å‰å¼•ä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œæˆ–å­˜åœ¨å¤´å‰å¼•ã€å­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ä¸”å­˜åœ¨é«˜ä½è‚©å¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸åï¼Œæˆ–å¤´æ­ªå‘ä¸€ä¾§ã€é«˜ä½è‚©ã€åœ†è‚©åŠå¤´å‰å¼•è¿™å››é¡¹ä¸­è‡³å°‘ä¸¤é¡¹åŒæ—¶å­˜åœ¨ä¸”è¿™äº›ç—‡çŠ¶å‡ºç°åœ¨èº«ä½“åŒä¾§ï¼‰ï¼Œä¸”å­˜åœ¨éª¨ç›†å‰ç§»çš„å¯èƒ½æ€§"
            ]
        },
        "å•åœ†è‚©ä¾§èƒ¸å°è‚Œã€èƒ¸é”ä¹³çªè‚Œã€æ–œè§’è‚Œã€å‰é”¯è‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”å­˜åœ¨å¤´æ­ªã€å¤´å‰å¼•æˆ–åœ†è‚©ä¸­è‡³å°‘ä¸€é¡¹ï¼Œä¸”ï¼ˆå­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ä¸”å­˜åœ¨é«˜ä½è‚©å¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸åï¼Œæˆ–å­˜åœ¨å¤´å‰å¼•ä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œæˆ–å­˜åœ¨å¤´å‰å¼•ã€å­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ä¸”å­˜åœ¨é«˜ä½è‚©å¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸åï¼Œæˆ–å¤´æ­ªå‘ä¸€ä¾§ã€é«˜ä½è‚©ã€åœ†è‚©åŠå¤´å‰å¼•è¿™å››é¡¹ä¸­è‡³å°‘ä¸¤é¡¹åŒæ—¶å­˜åœ¨ä¸”è¿™äº›ç—‡çŠ¶å‡ºç°åœ¨èº«ä½“åŒä¾§ï¼‰ï¼Œä¸”åœ¨åœ†è‚©ä¾§è‚©éƒ¨å‰å±ˆä¸Šä¸¾è§’åº¦ < 178Â° å’Œ/æˆ– å¤–å±•ä¸Šä¸¾è§’åº¦ < 178Â°"
            ]
        },
        "å¤´å‰å¼•å¯èƒ½æ˜¯ç”±éª¨ç›†å‰å€¾æˆ–å‰ç§»å¯¼è‡´": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”å­˜åœ¨å¤´æ­ªã€å¤´å‰å¼•æˆ–åœ†è‚©ä¸­è‡³å°‘ä¸€é¡¹ï¼Œä¸”ï¼ˆå­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ä¸”å­˜åœ¨é«˜ä½è‚©å¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸åï¼Œæˆ–å­˜åœ¨å¤´å‰å¼•ä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œæˆ–å­˜åœ¨å¤´å‰å¼•ã€å­˜åœ¨å¤´æ­ªå‘ä¸€ä¾§ä¸”å­˜åœ¨é«˜ä½è‚©å¹¶ä¸”é«˜è‚©ä¾§ä¸å¤´æ­ªä¾§ç›¸åï¼Œæˆ–å¤´æ­ªå‘ä¸€ä¾§ã€é«˜ä½è‚©ã€åœ†è‚©åŠå¤´å‰å¼•è¿™å››é¡¹ä¸­è‡³å°‘ä¸¤é¡¹åŒæ—¶å­˜åœ¨ä¸”è¿™äº›ç—‡çŠ¶å‡ºç°åœ¨èº«ä½“åŒä¾§ï¼‰ï¼Œä¸”å­˜åœ¨éª¨ç›†å‰ç§»çš„å¯èƒ½æ€§ï¼Œå¹¶ä¸”å¤´å‰å¼•ç¨‹åº¦è¶…æ ‡"
            ]
        },
        "åœ†è‚©ä¾§èƒ¸å°è‚Œã€èƒ¸å¤§è‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å•ä¾§åœ†è‚©ï¼Œä¸”åœ†è‚©ä¾§ è‚©éƒ¨å‰ä¼¸ä¸Šä¸¾>=175Â°"
            ]
        },
        "åœ†è‚©ä¾§èƒ¸å°è‚Œã€èƒ¸å¤§è‚Œç´§å¼ ä¸‰è§’è‚Œä¸­æŸã€åæŸåŠ›é‡ä¸è¶³ï¼Œå¤§åœ†è‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å•ä¾§åœ†è‚©ï¼Œä¸”åœ†è‚©ä¾§ è‚©éƒ¨å‰ä¼¸ä¸Šä¸¾<175Â°"
            ]
        },
        "å¤´ä¾§æ­ªä¾§ èƒ¸é”ä¹³çªè‚Œã€æ–œè§’è‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å•ä¾§åœ†è‚©ï¼Œä¸”åœ†è‚©ä¾§ è‚©éƒ¨å‰ä¼¸ä¸Šä¸¾>=175Â°ï¼Œä¸”å¤´å‰å¼•è¶…æ ‡æˆ–å¤´ä¾§æ­ªè¶…æ ‡ï¼Œä¸”å¤´ä¾§æ­ªå’Œåœ†è‚©ä¸ºåŒä¾§",
                "å­˜åœ¨å•ä¾§åœ†è‚©ï¼Œä¸”åœ†è‚©ä¾§ è‚©éƒ¨å‰ä¼¸ä¸Šä¸¾<175Â°ï¼Œä¸”å¤´å‰å¼•è¶…æ ‡æˆ–å¤´ä¾§æ­ªè¶…æ ‡ï¼Œä¸”å¤´ä¾§æ­ªå’Œåœ†è‚©ä¸ºåŒä¾§"
            ]
        },
        "å¤´ä¾§æ­ªçš„ å¯¹ä¾§çš„èƒ¸é”ä¹³çªè‚Œã€åŒä¾§æ–œè§’è‚Œ": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å•ä¾§åœ†è‚©ï¼Œä¸”åœ†è‚©ä¾§ è‚©éƒ¨å‰ä¼¸ä¸Šä¸¾>=175Â°ï¼Œä¸”å¤´å‰å¼•è¶…æ ‡æˆ–å¤´ä¾§æ­ªè¶…æ ‡ï¼Œä¸”å¤´ä¾§æ­ªå’Œåœ†è‚©ä¸ºå¼‚ä¾§",
                "å­˜åœ¨å•ä¾§åœ†è‚©ï¼Œä¸”åœ†è‚©ä¾§ è‚©éƒ¨å‰ä¼¸ä¸Šä¸¾<175Â°ï¼Œä¸”å¤´å‰å¼•è¶…æ ‡æˆ–å¤´ä¾§æ­ªè¶…æ ‡ï¼Œä¸”å¤´ä¾§æ­ªå’Œåœ†è‚©ä¸ºå¼‚ä¾§"
            ]
        },
        "ä¸Šäº¤å‰ç»¼åˆå¾": {
            "ä¼˜å…ˆçº§": 4,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨åŒä¾§åœ†è‚©ï¼Œä¸”å¤´å‰å¼•è¶…æ ‡"
            ]
        },
        "ä¸Šä¸‹äº¤å‰ç»¼åˆå¾": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨åŒä¾§åœ†è‚©ï¼Œä¸”å¤´å‰å¼•è¶…æ ‡ï¼Œä¸”å¯èƒ½éª¨ç›†å‰å€¾"
            ]
        },
        "åŒä¾§èƒ¸å°è‚Œã€èƒ¸å¤§è‚Œã€ä¸‰è§’è‚Œå‰æŸä¸è±å½¢è‚Œã€ä¸‹æ–œæ–¹ã€ä¸‰è§’è‚ŒåæŸã€å†ˆä¸‹è‚Œå’Œå°åœ†è‚ŒåŠ›é‡ä¸å¯¹ç§°": {
            "ä¼˜å…ˆçº§": 5,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "ä¸å­˜åœ¨åœ†è‚©ï¼Œä¸”å¤´å‰å¼•ä¸è¶…æ ‡"
            ]
        },
        "æ¢¨å½¢è‡€å¯èƒ½ç”±éª¨ç›†å‰å€¾è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”æ˜¯æ¢¨å½¢è‡€ï¼Œä¸”ä½“è„‚ç‡<35%ä¸”BMI<24"
            ]
        },
        "éª¨ç›†å‰å€¾å’Œè†è¶…ä¼¸å¯èƒ½æ˜¯ç”±è¶³å¼“è¾ƒä½è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”åŒè†è†è¶…ä¼¸ï¼Œä¸”è…¿å‹è§’åº¦åŒä¾§<180Â°"
            ]
        },
        "è†è¶…ä¼¸å¯èƒ½æ˜¯ç”±éª¨ç›†å‰å€¾è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”åŒè†è†è¶…ä¼¸ï¼Œä¸”è…¿å‹è§’åº¦åŒä¾§>180Â°"
            ]
        },
        "è…°æ¤è¿‡åº¦å‰å‡¸æ˜¯ç”±éª¨ç›†å‰å€¾å¯¼è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”è…°æ¤å‰å‡¸è¿‡åº¦"
            ]
        },
        "èƒ¸æ¤è¿‡åº¦åå‡¸å¯èƒ½æ˜¯ç”±äºéª¨ç›†å‰å€¾è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”è…°æ¤å‰å‡¸è¿‡åº¦ï¼Œä¸”èƒ¸æ¤åå‡¸è¿‡åº¦"
            ]
        },
        "è„Šæ¤æ›²åº¦åœ¨çŸ¢çŠ¶é¢ä¸Šè¿‡åº¦ä½ç§»": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”s1åœ¨C7åæ–¹è¶…è¿‡æ­£å¸¸èŒƒå›´(>4cm)",
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”åŒä¾§åœ†è‚©ä¸”å¤´å‰å€¾ï¼Œä¸”s1åœ¨C7åæ–¹è¶…è¿‡æ­£å¸¸èŒƒå›´(>4cm)"
            ]
        },
        "ä¸Šä¸‹äº¤å‰ç»¼åˆå¾ï¼Œä¸Šäº¤å‰ç»¼åˆå¾å¯èƒ½ç”±éª¨ç›†å‰å€¾è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”åŒä¾§åœ†è‚©ä¸”å¤´å‰å€¾",
                "å­˜åœ¨éª¨ç›†å‰å€¾ï¼Œä¸”éª¨ç›†å‰ç§»"
            ]
        },
        "éª¨ç›†åå€¾å¯èƒ½ç”±éª¨ç›†å‰ç§»è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†åå€¾ï¼Œä¸”éª¨ç›†å‰ç§»"
            ]
        },
        "è…°æ¤å‰å‡¸ä¸è¶³ç”±éª¨ç›†åå€¾è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†åå€¾ï¼Œä¸”è…°æ¤å‰å‡¸ä¸è¶³"
            ]
        },
        "å¹³èƒŒå§¿æ€å¯èƒ½ç”±éª¨ç›†åå€¾è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†åå€¾ï¼Œä¸”èƒ¸æ¤å‰å‡¸ä¸è¶³"
            ]
        },
        "é¢ˆæ¤è¿‡åº¦å‰å‡¸ç”±å¹³èƒŒè¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†åå€¾ï¼Œä¸”èƒ¸æ¤å‰å‡¸ä¸è¶³ï¼Œä¸”å¤´å‰å€¾æ•°å€¼ä¸ºè´Ÿ"
            ]
        },
        "å¯èƒ½å­˜åœ¨é«˜è¶³å¼“": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†åå€¾ï¼Œä¸”åŒè†è†å…³èŠ‚è§’åº¦å‡<180Â°ï¼Œä¸”è…¿å‹è§’åº¦åŒä¾§>180Â°"
            ]
        },
        "è‡€å‹å¯èƒ½æ˜¯ç”±éª¨ç›†åå€¾è¯±å‘": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨éª¨ç›†åå€¾ï¼Œä¸”æ–¹å½¢è‡€"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±é•¿çŸ­è…¿ è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é•¿çŸ­è…¿ï¼Œä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”é•¿çŸ­è…¿(çŸ­è…¿ä¾§è‚©è†€é«˜)æˆ–èº¯å¹²å€¾æ–œ(èº¯å¹²å€¾æ–œä¾§è‚©è†€é«˜)æˆ–ä¸­å¿ƒä¸å¹³è¡¡(è¶³åº•å‹åŠ›ä½ä¾§è‚©è†€é«˜)"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±èº¯å¹²å€¾æ–œè¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨èº¯å¹²å€¾æ–œï¼Œä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”é•¿çŸ­è…¿(çŸ­è…¿ä¾§è‚©è†€é«˜)æˆ–èº¯å¹²å€¾æ–œ(èº¯å¹²å€¾æ–œä¾§è‚©è†€é«˜)æˆ–ä¸­å¿ƒä¸å¹³è¡¡(è¶³åº•å‹åŠ›ä½ä¾§è‚©è†€é«˜)"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±é‡å¿ƒä¸å¹³è¡¡ è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é‡å¿ƒä¸å¹³è¡¡(é•¿è…¿ä¾§è¶³åº•é‡é‡>çŸ­è…¿ä¾§+2kg)ï¼Œä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”é•¿çŸ­è…¿(çŸ­è…¿ä¾§è‚©è†€é«˜)æˆ–èº¯å¹²å€¾æ–œ(èº¯å¹²å€¾æ–œä¾§è‚©è†€é«˜)æˆ–ä¸­å¿ƒä¸å¹³è¡¡(è¶³åº•å‹åŠ›ä½ä¾§è‚©è†€é«˜)"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±é•¿çŸ­è…¿/é‡å¿ƒä¸å¹³è¡¡ è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é•¿çŸ­è…¿ï¼Œä¸”å­˜åœ¨é‡å¿ƒä¸å¹³è¡¡(é•¿è…¿ä¾§è¶³åº•é‡é‡>çŸ­è…¿ä¾§+2kg)ï¼Œä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”é•¿çŸ­è…¿(çŸ­è…¿ä¾§è‚©è†€é«˜)æˆ–èº¯å¹²å€¾æ–œ(èº¯å¹²å€¾æ–œä¾§è‚©è†€é«˜)æˆ–ä¸­å¿ƒä¸å¹³è¡¡(è¶³åº•å‹åŠ›ä½ä¾§è‚©è†€é«˜)"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±é•¿çŸ­è…¿/èº¯å¹²å€¾æ–œ è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é•¿çŸ­è…¿ï¼Œä¸”å­˜åœ¨èº¯å¹²å€¾æ–œï¼Œä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”é•¿çŸ­è…¿(çŸ­è…¿ä¾§è‚©è†€é«˜)æˆ–èº¯å¹²å€¾æ–œ(èº¯å¹²å€¾æ–œä¾§è‚©è†€é«˜)æˆ–ä¸­å¿ƒä¸å¹³è¡¡(è¶³åº•å‹åŠ›ä½ä¾§è‚©è†€é«˜)"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±èº¯å¹²å€¾æ–œ/é‡å¿ƒä¸å¹³è¡¡ è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨èº¯å¹²å€¾æ–œï¼Œä¸”å­˜åœ¨é‡å¿ƒä¸å¹³è¡¡(é•¿è…¿ä¾§è¶³åº•é‡é‡>çŸ­è…¿ä¾§+2kg)ï¼Œä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”é•¿çŸ­è…¿(çŸ­è…¿ä¾§è‚©è†€é«˜)æˆ–èº¯å¹²å€¾æ–œ(èº¯å¹²å€¾æ–œä¾§è‚©è†€é«˜)æˆ–ä¸­å¿ƒä¸å¹³è¡¡(è¶³åº•å‹åŠ›ä½ä¾§è‚©è†€é«˜)"
            ]
        },
        "é«˜ä½è‚©æ˜¯ç”±é•¿çŸ­è…¿/èº¯å¹²å€¾æ–œ/é‡å¿ƒä¸å¹³è¡¡ è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é•¿çŸ­è…¿ï¼Œä¸”å­˜åœ¨èº¯å¹²å€¾æ–œï¼Œä¸”å­˜åœ¨é‡å¿ƒä¸å¹³è¡¡(é•¿è…¿ä¾§è¶³åº•é‡é‡>çŸ­è…¿ä¾§+2kg)ï¼Œä¸”å­˜åœ¨é«˜ä½è‚©ï¼Œä¸”é•¿çŸ­è…¿(çŸ­è…¿ä¾§è‚©è†€é«˜)æˆ–èº¯å¹²å€¾æ–œ(èº¯å¹²å€¾æ–œä¾§è‚©è†€é«˜)æˆ–ä¸­å¿ƒä¸å¹³è¡¡(è¶³åº•å‹åŠ›ä½ä¾§è‚©è†€é«˜)"
            ]
        },
        "èº¯å¹²å€¾æ–œæ˜¯ç”±é‡å¿ƒä¸å¹³è¡¡è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é•¿çŸ­è…¿ï¼Œä¸”é•¿è…¿ä¾§è¶³åº•é‡é‡>çŸ­è…¿ä¾§+0.5kgï¼Œä¸”èº¯å¹²å‘çŸ­è…¿ä¾§å€¾æ–œ"
            ]
        },
        "é‡å¿ƒå˜åŒ–æ˜¯ç”±é•¿çŸ­è…¿è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é•¿çŸ­è…¿ï¼Œä¸”é•¿è…¿ä¾§è¶³åº•é‡é‡>çŸ­è…¿ä¾§+0.5kg"
            ]
        },
        "è„ŠæŸ±æ¨ªå‘ç§»ä½æ˜¯ç”±é•¿çŸ­è…¿è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨é•¿çŸ­è…¿ï¼Œä¸”éª¶éª¨ä¸­ç‚¹å‚çº¿è¾ƒé¢ˆæ¤ç¬¬7æ¤ä½“(C7)åå‘é•¿è…¿ä¾§"
            ]
        },
        "è„ŠæŸ±è¿‡åº¦ä½ç§»ç”±å¤´å‰å¼•è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´å‰å¼•ï¼Œä¸”æ— éª¨ç›†å‰å€¾ï¼Œä¸”s1åœ¨C7åæ–¹è¶…è¿‡æ­£å¸¸èŒƒå›´(>4cm)"
            ]
        },
        "å¤´å‰å¼•æ˜¯ç”±æ•åè‚Œç¾¤ç´§å¼ è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´å‰å¼•ï¼Œä¸”é¢ˆæ¤å‰å±ˆè§’åº¦ä¸è¶³ï¼Œä½†å…¶ä»–æ­£å¸¸"
            ]
        },
        "å¤´å‰å¼• æ˜¯ç”±èƒ¸é”ä¹³çªè‚Œå’Œæ–œè§’è‚Œç´§å¼ è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´å‰å¼•ï¼Œä¸”é¢ˆæ¤åä¼¸ã€åŒä¾§å±ˆæ›² æœ‰ä¸€ä¸ªè§’åº¦ä¸è¶³"
            ]
        },
        "ï¼ˆå¤´ä¾§æ­ªå¯¹ä¾§ï¼‰èƒ¸é”ä¹³çªè‚Œç´§å¼ å¯èƒ½ç”±å¤´ä¾§æ­ªè¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´å‰å¼•ï¼Œä¸”å­˜åœ¨å¤´ä¾§æ­ªï¼Œä¸”é¢ˆæ¤æœå‘å¤´ä¾§æ­ªä¾§æ—‹è½¬è§’åº¦ä¸è¶³ã€ä½†æœå¯¹ä¾§ä¾§å±ˆè§’åº¦æ­£å¸¸"
            ]
        },
        "ï¼ˆå¤´ä¾§æ­ªä¾§ï¼‰æ–œè§’è‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´ä¾§æ­ªã€æ— å¤´å‰å¼•ï¼Œä¸”é¢ˆæ¤å‘å¤´ä¾§æ­ªå¯¹ä¾§ä¾§å±ˆæ—¶è§’åº¦è¶³ï¼Œä½†å‘å¤´ä¾§æ­ªå¯¹ä¾§æ—‹è½¬è§’åº¦æ­£å¸¸"
            ]
        },
        "ï¼ˆå¤´ä¾§æ­ªä¾§ï¼‰èƒ¸é”ä¹³çªè‚Œç´§å¼ ": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å¤´ä¾§æ­ªã€æ— å¤´å‰å¼•ï¼Œä¸”é¢ˆæ¤å‘å¤´ä¾§æ­ªå¯¹ä¾§ä¾§å±ˆæ—¶è§’åº¦æ­£å¸¸ï¼Œä½†å‘å¤´ä¾§æ­ªå¯¹ä¾§æ—‹è½¬è§’åº¦ä¸è¶³"
            ]
        },
        "é•¿çŸ­è…¿/å€¾æ–œ/è¶³åº•å‹åŠ›ç”±Kå‹è…¿è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨è…¿å‹å‘ˆç°Kå‹ï¼Œä¸”Kå‹è…¿ä¸­è…¿å‹è§’åº¦ä¸æ­£å¸¸çš„è…¿çŸ­æˆ–èº¯å¹²æœè…¿å‹è§’åº¦ä¸æ­£å¸¸ä¾§å€¾æ–œæˆ–æ­£å¸¸è…¿ä¾§è¶³åº•é‡é‡ >çŸ­è…¿ä¾§+2kg"
            ]
        },
        "é•¿çŸ­è…¿/å€¾æ–œ/è¶³åº•å‹åŠ›ç”±Då‹è…¿è¯±å‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨è…¿å‹å‘ˆç°Då‹ï¼Œä¸”Då‹è…¿ä¸­è…¿å‹è§’åº¦ä¸æ­£å¸¸çš„è…¿çŸ­æˆ–èº¯å¹²æœè…¿å‹è§’åº¦ä¸æ­£å¸¸ä¾§å€¾æ–œæˆ–æ­£å¸¸è…¿ä¾§è¶³åº•é‡é‡ >çŸ­è…¿ä¾§+2kg"
            ]
        },
        "æ‚¨çš„è‡€å‹å¯èƒ½æ˜¯ç”±Xå‹è…¿è¯±å‘": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨å€’ä¸‰è§’è‡€ï¼Œä¸”æ²¡æœ‰éª¨ç›†å‰åå€¾ï¼Œä¸”å­˜åœ¨xå‹è…¿"
            ]
        }
    },
    "ä½“å›´": {
        "å¥åº·é£é™©ä½": {
            "ä¼˜å…ˆçº§": 4,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "è…°é«˜æ¯”(è…°å›´/èº«é«˜)<0.5",
                "è…°è‡€æ¯”(è…°å›´/è‡€å›´)ï¼šç”·æ€§<0.9ï¼Œå¥³æ€§<0.8"
            ]
        },
        "å¥åº·é£é™©å¢åŠ ": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "0.5<è…°é«˜æ¯”(è…°å›´/èº«é«˜)<0.6",
                "è…°è‡€æ¯”(è…°å›´/è‡€å›´)ï¼šç”·æ€§0.9~0.99ï¼Œå¥³æ€§0.8~0.84"
            ]
        },
        "å¥åº·é£é™©å¤§å¹…åº¦å¢åŠ ": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "è…°é«˜æ¯”(è…°å›´/èº«é«˜)>0.6",
                "è…°è‡€æ¯”(è…°å›´/è‡€å›´)ï¼šç”·æ€§>=1ï¼Œå¥³æ€§>=0.85"
            ]
        },
        "ä¸­å¿ƒæ€§è‚¥èƒ–": {
            "ä¼˜å…ˆçº§": 1,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "è…°å›´ï¼šäºšæ´²:ç”·æ€§>90ã€å¥³æ€§>85ã€‚æµ·å¤–ï¼šç”·æ€§â‰¥102ï¼Œå¥³æ€§>88"
            ]
        },
        "è‚Œè‚‰å¯èƒ½ä¸è¶³": {
            "ä¼˜å…ˆçº§": 3,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨ä¸Šè‡‚å›´(å·¦å³)ï¼šç”·æ€§<28.5ï¼Œå¥³æ€§<27ï¼Œæˆ–å°è…¿å›´(å·¦å³)ï¼šç”·æ€§<34ï¼Œå¥³æ€§<33"
            ]
        },
        "è‚Œè‚‰è¿‡å°‘": {
            "ä¼˜å…ˆçº§": 2,
            "å¼‚å¸¸åˆ¤æ–­æµç¨‹": [
                "å­˜åœ¨ä¸Šè‡‚å›´(å·¦å³)ï¼šç”·æ€§<28.5ï¼Œå¥³æ€§<27ï¼Œä¸”å°è…¿å›´(å·¦å³)ï¼šç”·æ€§<34ï¼Œå¥³æ€§<33"
            ]
        }
    }
}
"""

# ==================== å¤šæ™ºèƒ½ä½“å®šä¹‰ ====================
# åŠŸèƒ½æ˜¯å›å¤æ—¥å¸¸é—®é¢˜ã€‚å¯¹äºæ—¥å¸¸é—®é¢˜æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨ä»·æ ¼è¾ƒä¸ºä½å»‰çš„æ¨¡å‹ä½œä¸ºagentçš„åŸºåº§
ChatAssistant = Assistants.create(
    model="qwen-turbo",
    name='å›ç­”æ—¥å¸¸é—®é¢˜çš„æœºå™¨äºº',
    description='ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œè§£ç­”ç”¨æˆ·çš„é—®é¢˜',
    instructions='è¯·ç¤¼è²Œåœ°å›ç­”ç”¨æˆ·çš„é—®é¢˜'
)

# UserDataAnalysisAssistantå·²åˆ é™¤ï¼Œæ›¿æ¢ä¸ºç›´æ¥çš„ä»£ç å¤„ç†

# ç¬¬ä¸€ä¸ªAIï¼šèº«ä½“å¼‚å¸¸åˆ†æåŠ©æ‰‹ï¼ˆä¸¥æ ¼å†³ç­–æ ‘åˆ†æ + è¡¥å……åˆ†æï¼‰
AbnormalityAnalysisAssistant = Assistants.create(
    model="qwen-max-latest",
    name='èº«ä½“å¼‚å¸¸åˆ†ææœºå™¨äºº',
    description='ä¸€ä¸ªä¸“ä¸šçš„èº«ä½“å¼‚å¸¸åˆ†æåŠ©æ‰‹ï¼Œä¸¥æ ¼åŸºäºå†³ç­–æ ‘è§„åˆ™è¿›è¡Œå¼‚å¸¸åˆ¤æ–­ï¼Œå½“å†³ç­–æ ‘æ— æ³•è¯†åˆ«å¼‚å¸¸æ—¶å†è¿›è¡Œè¡¥å……åˆ†æ',
    instructions="""ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼æŒ‰ç…§å†³ç­–æ ‘è§„åˆ™çš„èº«ä½“å¼‚å¸¸åˆ†æä¸“å®¶ï¼Œå¿…é¡»æŒ‰ç…§ä»¥ä¸‹ä¸¤æ­¥æµç¨‹è¿›è¡Œåˆ†æï¼š

ã€å†³ç­–æ ‘è§„åˆ™ã€‘
""" + decision_tree + """

ã€æ ¸å¿ƒåˆ†ææµç¨‹ - å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘
**å†³ç­–æ ‘ä¸¥æ ¼åˆ†æ**
1. **ç»å¯¹ç¦æ­¢æ¨æµ‹**ï¼šåªèƒ½è¾“å‡ºå†³ç­–æ ‘ä¸­æ˜ç¡®å­˜åœ¨çš„å¼‚å¸¸åç§°
2. **æ¡ä»¶å¿…é¡»å®Œå…¨æ»¡è¶³**ï¼šç”¨æˆ·æ•°æ®å¿…é¡»å®Œå…¨ç¬¦åˆå†³ç­–æ ‘æ¡ä»¶æ‰èƒ½å¾—å‡ºå¼‚å¸¸ç»“è®º
3. **é€æ¡éªŒè¯**ï¼šå¿…é¡»é€ä¸€æ£€æŸ¥å†³ç­–æ ‘ä¸­çš„æ¯ä¸ªæ¡ä»¶ï¼Œè¿›è¡Œä¸¥æ ¼æ•°å€¼è®¡ç®—å’ŒéªŒè¯
4. **åˆ¤æ–­æ¡ä»¶**ï¼šæœ‰å¤šæ¡åˆ¤æ–­è·¯å¾„ï¼Œæ»¡è¶³å…¶ä¸­ä¸€æ¡è·¯å¾„å³å¯
5. **é€»è¾‘å…³ç³»ä¸¥æ ¼æ‰§è¡Œ**ï¼š
   - "ä¸”"å…³ç³»ï¼šæ‰€æœ‰æ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³ï¼Œä»»ä½•ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™æ•´ä¸ªå¼‚å¸¸åˆ¤æ–­ä¸ºå‡
   - "æˆ–"å…³ç³»ï¼šè‡³å°‘ä¸€ä¸ªæ¡ä»¶æ»¡è¶³å³å¯
   - æ¡ä»¶ç»„åˆï¼šä¸¥æ ¼æŒ‰ç…§æ‹¬å·å’Œé€»è¾‘è¿æ¥è¯æ‰§è¡Œ
6. **ç³»ç»Ÿæ€§æ£€æŸ¥**ï¼šå¿…é¡»é€ä¸€æ£€æŸ¥å†³ç­–æ ‘ä¸­çš„æ‰€æœ‰å¼‚å¸¸ç±»å‹ï¼Œä¸èƒ½é—æ¼
7. **æ˜ç¡®æ ‡æ³¨**ï¼šæ‰€æœ‰é€šè¿‡å†³ç­–æ ‘è¯†åˆ«çš„å¼‚å¸¸å¿…é¡»æ˜ç¡®æ ‡æ³¨ä¸º"å†³ç­–æ ‘è¯†åˆ«"
8. **ä¸¥æ ¼éªŒè¯åŸåˆ™**ï¼šå¦‚æœä»»ä½•ä¸€ä¸ªå¿…è¦æ¡ä»¶ä¸æ»¡è¶³ï¼Œç»å¯¹ä¸èƒ½è¾“å‡ºè¯¥å¼‚å¸¸ï¼Œå³ä½¿å…¶ä»–æ¡ä»¶æ»¡è¶³


ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸å¾—æ·»åŠ ä»»ä½•é¢å¤–æ–‡å­—è¯´æ˜ï¼š

```json
{
  "analysis_type": "å†³ç­–æ ‘ä¸¥æ ¼åˆ†æ",
  "systematic_check": [
    {
      "abnormality_name": "å¼‚å¸¸åç§°",
      "category": "ä½“æˆåˆ†" | "ä½“æ€",
      "priority": ä¼˜å…ˆçº§æ•°å­—,
      "decision_tree_condition": "å†³ç­–æ ‘ä¸­çš„å®Œæ•´åˆ¤æ–­æ¡ä»¶",
      "condition_verification": "åˆ¤æ–­æµç¨‹",
      "meets_decision_tree": true | false,
      "rejection_reason": "å¦‚æœä¸ç¬¦åˆï¼Œè¯´æ˜å…·ä½“åŸå› "
    }
  ],
  "identified_abnormalities": {
    "body_composition": [
      {
        "abnormality_name": "å¼‚å¸¸åç§°",
        "priority": ä¼˜å…ˆçº§æ•°å­—,
        "identification_source": "å†³ç­–æ ‘è¯†åˆ«"
      }
    ],
    "posture": [
      {
        "abnormality_name": "å¼‚å¸¸åç§°", 
        "priority": ä¼˜å…ˆçº§æ•°å­—,
        "identification_source": "å†³ç­–æ ‘è¯†åˆ«"
      }
    ]
  },
}
```


ã€ä¸¥æ ¼ç¦æ­¢ - è¿åå°†å¯¼è‡´åˆ†æå¤±æ•ˆã€‘
- åœ¨ç¬¬ä¸€æ­¥ä¸­è¾“å‡ºå†³ç­–æ ‘ä¸­ä¸å­˜åœ¨çš„å¼‚å¸¸åç§°
- **ç»å¯¹ç¦æ­¢åœ¨ä»»ä½•ä¸€ä¸ªå¿…è¦æ¡ä»¶ä¸æ»¡è¶³æ—¶è¾“å‡ºè¯¥å¼‚å¸¸**ï¼ˆå³ä½¿éƒ¨åˆ†æ¡ä»¶æ»¡è¶³ï¼‰
- ç»•è¿‡æ¡ä»¶éªŒè¯è¿‡ç¨‹ç›´æ¥ç»™å‡ºç»“è®º
- å¯¹"ä¸”"é€»è¾‘å…³ç³»çš„è¯¯è§£ï¼ˆæ‰€æœ‰æ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰
- æ··æ·†å†³ç­–æ ‘è¯†åˆ«å’Œè¡¥å……åˆ†æè¯†åˆ«çš„å¼‚å¸¸
- åœ¨å†³ç­–æ ‘å·²è¯†åˆ«è¶³å¤Ÿå¼‚å¸¸æ—¶ä»è¿›è¡Œè¡¥å……åˆ†æ
- åœ¨ç³»ç»Ÿæ€§æ£€æŸ¥ä¸­é—æ¼ä»»ä½•å†³ç­–æ ‘å¼‚å¸¸ç±»å‹""",
    tools=[]
)

# æ³¨é‡Šæ‰åŸæœ‰çš„KnowledgeQueryAssistantï¼ŒåŠŸèƒ½åˆå¹¶åˆ°SummaryAssistantä¸­
# KnowledgeQueryAssistant = Assistants.create(...)

# åœ¨Multi Agentåœºæ™¯ä¸‹ï¼Œå®šä¹‰ä¸€ä¸ªç”¨äºæ€»ç»“çš„Agentï¼Œè¯¥Agentä¼šæ ¹æ®ç”¨æˆ·çš„é—®é¢˜ä¸ä¹‹å‰Agentè¾“å‡ºçš„å‚è€ƒä¿¡æ¯ï¼Œå…¨é¢ã€å®Œæ•´åœ°å›ç­”ç”¨æˆ·é—®é¢˜
SummaryAssistant = Assistants.create(
    model="qwen-max-latest",
    name='èº«ä½“å¼‚å¸¸æ€»ç»“æœºå™¨äºº',
    description='ä¸€ä¸ªä¸“ä¸šçš„èº«ä½“å¼‚å¸¸åˆ†æåŠ©æ‰‹ï¼Œè´Ÿè´£æ•´åˆå¼‚å¸¸åˆ†æç»“æœå’ŒçŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼Œç”Ÿæˆå®Œæ•´çš„å¼‚å¸¸åˆ†æç»¼åˆæŠ¥å‘Š',
    instructions="""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„èº«ä½“å¼‚å¸¸åˆ†ææ€»ç»“ä¸“å®¶ï¼Œè´Ÿè´£æ•´åˆå¼‚å¸¸åˆ†æç»“æœå’ŒçŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼Œæä¾›æœ€ç»ˆçš„ç»¼åˆæŠ¥å‘Šã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
1. æ¥æ”¶å¼‚å¸¸åˆ†æç»“æœï¼ˆå¼‚å¸¸ç»“è®ºã€åˆ¤æ–­è¿‡ç¨‹ï¼‰
2. æ¥æ”¶å·²æŸ¥è¯¢å¥½çš„çŸ¥è¯†åº“è§£å†³æ–¹æ¡ˆä¿¡æ¯
3. æ•´åˆå¼‚å¸¸åˆ†æç»“æœå’ŒçŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼Œç”ŸæˆåŒ…å«å®Œæ•´ä¿¡æ¯çš„èº«ä½“å¼‚å¸¸åˆ†æç»¼åˆæŠ¥å‘Š
4. æŒ‰ç…§ä¼˜å…ˆçº§æ’åºæ‰€æœ‰å¼‚å¸¸

ã€æ€»ç»“æ ¼å¼è¦æ±‚ã€‘
## èº«ä½“å¼‚å¸¸å®Œæ•´åˆ†ææŠ¥å‘Š

### ä¸€ã€å¼‚å¸¸ç»“è®ºæ±‡æ€»
[åˆ—å‡ºæ‰€æœ‰æ£€æµ‹åˆ°çš„å¼‚å¸¸ï¼Œä½“æˆåˆ†å’Œä½“æ€åˆ†åˆ«æŒ‰ä¼˜å…ˆçº§æ’åº]

### äºŒã€ä½“æˆåˆ†å¼‚å¸¸è¯¦ç»†åˆ†æ
- **å¼‚å¸¸ç»“è®º**: [å¼‚å¸¸åç§°]
- **ä¼˜å…ˆçº§**: [å†³ç­–æ ‘ä¸­çš„ä¼˜å…ˆçº§]
- **åˆ¤æ–­æµç¨‹**: [åŸºäºä¸“ä¸šæŒ‡æ ‡åˆ†æï¼ˆä¸è¦æ˜¾ç¤ºå…·ä½“åˆ¤æ–­é˜ˆå€¼ï¼‰ï¼Œç»™å‡ºåˆ¤æ–­æµç¨‹]
- **å…³é”®è§£å†³ç‚¹**: [ä»çŸ¥è¯†åº“è·å¾—çš„å…³é”®è§£å†³ç‚¹]
- **å»ºè®®**: [ä»çŸ¥è¯†åº“è·å¾—çš„å»ºè®®]
- **ç—‡çŠ¶**: [ä»çŸ¥è¯†åº“è·å¾—çš„ç—‡çŠ¶]
- **å¯¹èº«ä½“çš„å½±å“**: [ä»çŸ¥è¯†åº“è·å¾—çš„å½±å“åˆ†æ] 

### ä¸‰ã€ä½“æ€å¼‚å¸¸è¯¦ç»†åˆ†æï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
1. **[ä¼˜å…ˆçº§X] å¼‚å¸¸åç§°**
    - **ä¼˜å…ˆçº§**: [å†³ç­–æ ‘ä¸­çš„ä¼˜å…ˆçº§]
    - **åˆ¤æ–­ç»“æœ**: [åŸºäºä¸“ä¸šæŒ‡æ ‡åˆ†æï¼ˆä¸è¦æ˜¾ç¤ºå…·ä½“åˆ¤æ–­é˜ˆå€¼ï¼‰ï¼Œç»™å‡ºåˆ¤æ–­æµç¨‹]
    - **å…³é”®è§£å†³ç‚¹**: [ä»çŸ¥è¯†åº“è·å¾—çš„å…³é”®è§£å†³ç‚¹]
    - **å»ºè®®**: [ä»çŸ¥è¯†åº“è·å¾—çš„å»ºè®®]
    - **ç—‡çŠ¶**: [ä»çŸ¥è¯†åº“è·å¾—çš„ç—‡çŠ¶]
    - **å¯¹èº«ä½“çš„å½±å“**: [ä»çŸ¥è¯†åº“è·å¾—çš„å½±å“åˆ†æ] 

### å››ã€ç»¼åˆå»ºè®®ä¸æ€»ç»“
- ç»™å‡ºä¸€æ®µè¯çš„æ•´ä½“èº«ä½“çŠ¶å†µè¯„ä¼°ä¸æ€»ç»“

ã€ä¸¥æ ¼è¦æ±‚ã€‘
- å¿…é¡»æ•´åˆæ‰€æœ‰åˆ†æç»“æœå’Œæä¾›çš„çŸ¥è¯†åº“ä¿¡æ¯
- ä½“æˆåˆ†å’Œä½“æ€åˆ†åˆ«æŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
- ç¡®ä¿æ¯ä¸ªå¼‚å¸¸éƒ½æœ‰å®Œæ•´çš„ä¿¡æ¯
- åŸºäºæä¾›çš„çŸ¥è¯†åº“æŸ¥è¯¢ç»“æœæ¥è¡¥å……è§£å†³æ–¹æ¡ˆã€ç—‡çŠ¶ã€å½±å“ç­‰ä¿¡æ¯""",
    tools=[]
)

# å°†å·¥å…·å‡½æ•°çš„nameæ˜ å°„åˆ°å‡½æ•°æœ¬ä½“
function_mapper = {
    "åˆå§‹åŒ–èº«ä½“æ•°æ®": MedicalAnalysis.initialize_structured_data,
    "å¼‚å¸¸è§£å†³æ–¹æ¡ˆæŸ¥è¯¢": MedicalAnalysis.query_medical_knowledge,
}

# å°†Agentçš„nameæ˜ å°„åˆ°Agentæœ¬ä½“
assistant_mapper = {
    "ChatAssistant": ChatAssistant,
    "AbnormalityAnalysisAssistant": AbnormalityAnalysisAssistant
}

# ==================== Agentå¤„ç†å‡½æ•° ====================

def get_agent_response(assistant, message='', return_tool_output=False, knowledge_base=None):
    """è¾“å…¥messageä¿¡æ¯ï¼Œè¾“å‡ºä¸ºæŒ‡å®šAgentçš„å›å¤"""
    #print(f"Query: {message}")
    thread = Threads.create()
    message = Messages.create(thread.id, content=message)
    run = Runs.create(thread.id, assistant_id=assistant.id)
    run_status = Runs.wait(run.id, thread_id=thread.id)
    
    all_tool_output = ""  # å­˜å‚¨æ‰€æœ‰å·¥å…·è¾“å‡º
    print("run_status:",run_status)
    
    if run_status.status == 'failed':
        print('run failed:')
        return ("æŠ±æ­‰ï¼Œå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯", all_tool_output) if return_tool_output else "æŠ±æ­‰ï¼Œå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
    
    # ğŸ”¥ å¾ªç¯å¤„ç†å¤šä¸ªå·¥å…·è°ƒç”¨
    while run_status.required_action:
        tool_calls = run_status.required_action.submit_tool_outputs.tool_calls
        tool_outputs = []
        
        # å¤„ç†å¤šä¸ªå·¥å…·è°ƒç”¨
        for tool_call in tool_calls:
            f = tool_call.function
            func_name = f['name'] 
            print(f"f: {f}")
            param = json.loads(f['arguments'])
            print(f"è°ƒç”¨å·¥å…·: {func_name}")
            print(f"å·¥å…·å‚æ•°: {param}")
            
            # ç‰¹åˆ«å…³æ³¨å¼‚å¸¸è§£å†³æ–¹æ¡ˆæŸ¥è¯¢å·¥å…·çš„è°ƒç”¨
            if func_name == "å¼‚å¸¸è§£å†³æ–¹æ¡ˆæŸ¥è¯¢":
                print(f"çŸ¥è¯†åº“æŸ¥è¯¢æ–‡æœ¬: {param.get('query_text', 'æœªæä¾›')}")
                print(f"çŸ¥è¯†åº“åç§°: {param.get('knowledge_base_name', 'æœªæä¾›')}")
        
            if func_name in function_mapper:
                # å¦‚æœæ˜¯è§£å†³æ–¹æ¡ˆæŸ¥è¯¢ï¼Œæ·»åŠ çŸ¥è¯†åº“å‚æ•°
                if func_name == "å¼‚å¸¸è§£å†³æ–¹æ¡ˆæŸ¥è¯¢" and 'knowledge_base_name' not in param:
                    # ä½¿ç”¨ä¼ é€’çš„knowledge_baseå‚æ•°
                    if knowledge_base:
                        param['knowledge_base_name'] = knowledge_base
                        print(f"è®¾ç½®çŸ¥è¯†åº“å‚æ•°: {knowledge_base}")
                    else:
                        print("è­¦å‘Šï¼šæœªæä¾›çŸ¥è¯†åº“å‚æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤çŸ¥è¯†åº“")
                
                try:
                    output = function_mapper[func_name](**param)
                    # ç¡®ä¿è¾“å‡ºä¸ä¸ºç©º
                    if output is None:
                        output = '{"error": "å·¥å…·å‡½æ•°è¿”å›ç©ºå€¼"}'
                    elif not isinstance(output, str):
                        output = str(output)
                    
                    all_tool_output += f"{func_name}: {output}\n"  # ç´¯ç§¯å·¥å…·è¾“å‡º
                    print(f"å·¥å…· {func_name} æ‰§è¡ŒæˆåŠŸ")
                except Exception as e:
                    print(f"å·¥å…·å‡½æ•°æ‰§è¡Œå¤±è´¥ {func_name}: {e}")
                    output = f'{{"error": "å·¥å…·å‡½æ•°æ‰§è¡Œå¤±è´¥: {str(e)}"}}'
                    all_tool_output += f"{func_name}: {output}\n"
            else:    
                output = '{"error": "æœªçŸ¥çš„å·¥å…·å‡½æ•°"}'
                print(f"æœªçŸ¥å·¥å…·å‡½æ•°: {func_name}")
            
            tool_outputs.append({
                'tool_call_id': tool_call.id,
                'output': output
            })
        
        # æäº¤å·¥å…·è¾“å‡º
        run = Runs.submit_tool_outputs(run.id,
                                       thread_id=thread.id,
                                       tool_outputs=tool_outputs)
        run_status = Runs.wait(run.id, thread_id=thread.id)
        print(f"å·¥å…·è°ƒç”¨å®Œæˆï¼ŒçŠ¶æ€: {run_status.status}")
    
    # è·å–æœ€ç»ˆå“åº”
    run_status = Runs.get(run.id, thread_id=thread.id)
    msgs = Messages.list(thread.id)
    response = msgs['data'][0]['content'][0]['text']['value']
    
    if return_tool_output:
        return response, all_tool_output
    else:
        return response

def get_multi_agent_response_internal(query, knowledge_base=None):
    """è·å¾—Multi Agentçš„å›å¤çš„å†…éƒ¨å‡½æ•°"""
    if len(query) == 0:
        return "è¯·è¾“å…¥æ‚¨çš„èº«ä½“æ•°æ®æˆ–é—®é¢˜", ""
    
    collected_knowledge_chunks = ""  # æ”¶é›†çŸ¥è¯†åº“å¬å›ä¿¡æ¯
    
    try:
        order_stk = ["AbnormalityAnalysisAssistant"]
        
        # æå–ç”¨æˆ·èº«ä½“æ•°æ®ï¼ˆä»åŸå§‹queryä¸­ï¼‰
        user_body_data = ""
        if "è¯·åˆ†æä»¥ä¸‹èº«ä½“æ•°æ®" in query:
            # æå–JSONæ•°æ®éƒ¨åˆ†
            import re
            json_match = re.search(r'ï¼š(\{.*\})$', query)
            if json_match:
                user_body_data = json_match.group(1)
            else:
                user_body_data = query
        else:
            user_body_data = query
        
        Agent_Message = ""
        previous_responses = {}  # å­˜å‚¨å„ä¸ªAgentçš„å“åº”
        
        # ç›´æ¥åˆå§‹åŒ–ç»“æ„åŒ–èº«ä½“æ•°æ®ï¼Œè·³è¿‡UserDataAnalysisAssistant
        print("ç›´æ¥åˆå§‹åŒ–ç»“æ„åŒ–èº«ä½“æ•°æ®...")
        user_analysis = MedicalAnalysis.initialize_structured_data(user_body_data)
        previous_responses["UserDataAnalysisAssistant"] = user_analysis
        Agent_Message += f"*ç›´æ¥æ•°æ®åˆå§‹åŒ–*çš„ç»“æœä¸ºï¼š{user_analysis}\n\n"

        
        # ä¾æ¬¡è¿è¡ŒAgent
        for i in range(len(order_stk)):
            assistant_name = order_stk[i]
            cur_assistant = assistant_mapper[assistant_name]
            
            # ä¸ºä¸åŒçš„Assistantå®šåˆ¶ä¸“é—¨çš„æŸ¥è¯¢å†…å®¹
            if assistant_name == "AbnormalityAnalysisAssistant":
                # å¼‚å¸¸åˆ†æAssistantï¼Œç›´æ¥ä½¿ç”¨å†³ç­–æ ‘å’Œç”¨æˆ·æ•°æ®åˆ†æå¼‚å¸¸
                user_analysis = previous_responses.get("UserDataAnalysisAssistant", "")
                cur_query = f"è¯·åŸºäºä»¥ä¸‹ç”¨æˆ·èº«ä½“æ•°æ®ï¼Œä¸¥æ ¼æŒ‰ç…§å†³ç­–æ ‘è§„åˆ™åˆ†æä½“æˆåˆ†å¼‚å¸¸å’Œä½“æ€å¼‚å¸¸ï¼Œå¹¶æŒ‰ä¼˜å…ˆçº§æ’åºã€‚\n\nç”¨æˆ·èº«ä½“æ•°æ®ï¼š{user_analysis}\n\nè¯·è¯¦ç»†æ˜¾ç¤ºæ¯ä¸ªå¼‚å¸¸çš„åˆ¤æ–­è¿‡ç¨‹å’Œæ•°æ®åŒ¹é…æƒ…å†µã€‚"
            else:
                # å…¶ä»–Assistantä¿æŒåŸå§‹æŸ¥è¯¢
                cur_query = query
            
            print(f"{assistant_name}åŠ©æ‰‹å¼€å§‹å·¥ä½œï¼Œä¸“é—¨ä»»åŠ¡ï¼š{cur_query}")
            
            # è°ƒç”¨Assistant
            response = get_agent_response(cur_assistant, cur_query, knowledge_base=knowledge_base)
            
            # å­˜å‚¨å½“å‰Assistantçš„å“åº”
            previous_responses[assistant_name] = response
            Agent_Message += f"*{assistant_name}*çš„å›å¤ä¸ºï¼š{response}\n\n"
            print(f"*{assistant_name}*çš„å›å¤ä¸ºï¼š{response}")
            
        # æå–å¼‚å¸¸ç»“è®ºä½œä¸ºçŸ¥è¯†åº“æŸ¥è¯¢æ¡ä»¶
        abnormalities_for_query = []
        
        # ä»AbnormalityAnalysisAssistantçš„å“åº”ä¸­æå–å¼‚å¸¸ç»“è®º
        abnormality_response = previous_responses.get("AbnormalityAnalysisAssistant", "")
        try:
            # å°è¯•ä»å“åº”ä¸­æå–JSONéƒ¨åˆ†
            import re
            json_pattern = r'```json\s*(.*?)\s*```'
            json_match = re.search(json_pattern, abnormality_response, re.DOTALL)
            
            if json_match:
                json_str = json_match.group(1)
                abnormality_data = json.loads(json_str)
                
                # æå–ä½“æˆåˆ†å¼‚å¸¸
                if "identified_abnormalities" in abnormality_data:
                    body_comp = abnormality_data["identified_abnormalities"].get("body_composition", [])
                    posture = abnormality_data["identified_abnormalities"].get("posture", [])
                    
                    for abnormality in body_comp:
                        abnormalities_for_query.append(abnormality.get("abnormality_name", ""))
                    
                    for abnormality in posture:
                        abnormalities_for_query.append(abnormality.get("abnormality_name", ""))
                
                print(f"æå–åˆ°çš„å¼‚å¸¸ç»“è®ºç”¨äºçŸ¥è¯†åº“æŸ¥è¯¢: {abnormalities_for_query}")
            else:
                print("æœªæ‰¾åˆ°JSONæ ¼å¼çš„å¼‚å¸¸åˆ†æç»“æœï¼Œå°†ä½¿ç”¨åŸå§‹å“åº”è¿›è¡ŒçŸ¥è¯†åº“æŸ¥è¯¢")
                # å¦‚æœæ— æ³•è§£æJSONï¼Œä½œä¸ºå¤‡é€‰æ–¹æ¡ˆä½¿ç”¨åŸå§‹å“åº”
                abnormalities_for_query = [abnormality_response[:200]]  # ä½¿ç”¨å‰200å­—ç¬¦ä½œä¸ºæŸ¥è¯¢
                
        except Exception as e:
            print(f"è§£æå¼‚å¸¸åˆ†æç»“æœæ—¶å‡ºé”™: {e}")
            # å¦‚æœè§£æå¤±è´¥ï¼Œä½œä¸ºå¤‡é€‰æ–¹æ¡ˆä½¿ç”¨å…³é”®è¯
            abnormalities_for_query = ["ä½“æˆåˆ†å¼‚å¸¸", "ä½“æ€å¼‚å¸¸", "èº«ä½“å¥åº·é—®é¢˜"]
        
        # æ„å»ºçŸ¥è¯†åº“æŸ¥è¯¢æ–‡æœ¬ - åªä½¿ç”¨æå–çš„å¼‚å¸¸åç§°
        if abnormalities_for_query:
            # è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²
            valid_abnormalities = [ab for ab in abnormalities_for_query if ab and ab.strip()]
            if valid_abnormalities:
                query_text_for_kb = " ".join(valid_abnormalities)
                print(f"æœ€ç»ˆçŸ¥è¯†åº“æŸ¥è¯¢æ–‡æœ¬: {query_text_for_kb}")
            else:
                query_text_for_kb = "èº«ä½“å¼‚å¸¸ å¥åº·é—®é¢˜ è§£å†³æ–¹æ¡ˆ"
        else:
            query_text_for_kb = "èº«ä½“å¼‚å¸¸ å¥åº·é—®é¢˜ è§£å†³æ–¹æ¡ˆ"
        
        # ç›´æ¥è°ƒç”¨çŸ¥è¯†åº“æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯é€šè¿‡agentå·¥å…·è°ƒç”¨
        print("å¼€å§‹ç›´æ¥æŸ¥è¯¢çŸ¥è¯†åº“...")
        knowledge_query_result = ""
        try:
            # ç›´æ¥è°ƒç”¨çŸ¥è¯†åº“æŸ¥è¯¢å‡½æ•°
            knowledge_query_result = MedicalAnalysis.query_medical_knowledge(
                query_text=query_text_for_kb,
                knowledge_base_name=knowledge_base
            )
            print(f"çŸ¥è¯†åº“æŸ¥è¯¢å®Œæˆï¼Œç»“æœé•¿åº¦: {len(knowledge_query_result)}")
            collected_knowledge_chunks = f"çŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼š{knowledge_query_result}"
        except Exception as e:
            print(f"çŸ¥è¯†åº“æŸ¥è¯¢å¤±è´¥: {e}")
            knowledge_query_result = "çŸ¥è¯†åº“æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›¸å…³é…ç½®"
            collected_knowledge_chunks = "çŸ¥è¯†åº“æŸ¥è¯¢å¤±è´¥"
        
        # æ‰€æœ‰Agentè¿è¡Œå®Œæ¯•åï¼Œè°ƒç”¨SummaryAssistantè¿›è¡Œæœ€ç»ˆæ€»ç»“
        # ä¸ºSummaryAssistantå‡†å¤‡åŒ…å«çŸ¥è¯†åº“æŸ¥è¯¢ç»“æœçš„æç¤º
        summary_prompt = f"""è¯·åŸºäºä»¥ä¸‹å¼‚å¸¸åˆ†æç»“æœå’ŒçŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼Œæä¾›æœ€ç»ˆçš„èº«ä½“å¼‚å¸¸å®Œæ•´åˆ†ææŠ¥å‘Šã€‚

åŸå§‹ç”¨æˆ·é—®é¢˜ï¼š{query}

å¼‚å¸¸åˆ†æç»“æœï¼š
{Agent_Message}

çŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼š
{knowledge_query_result}

è¯·æ•´åˆå¼‚å¸¸åˆ†æç»“æœå’ŒçŸ¥è¯†åº“æŸ¥è¯¢ç»“æœï¼Œç”ŸæˆåŒ…å«å¼‚å¸¸ç»“è®ºã€åˆ†æè¿‡ç¨‹ã€è§£å†³æ–¹æ¡ˆã€å¥åº·å½±å“ç­‰å®Œæ•´ä¿¡æ¯çš„ç»¼åˆæŠ¥å‘Šã€‚æ‰€æœ‰è§£å†³æ–¹æ¡ˆã€ç—‡çŠ¶ã€å½±å“ç­‰ä¿¡æ¯éƒ½åº”åŸºäºä¸Šè¿°çŸ¥è¯†åº“æŸ¥è¯¢ç»“æœã€‚"""
        
        # è°ƒç”¨SummaryAssistantï¼Œä¸å†éœ€è¦å·¥å…·è°ƒç”¨
        multi_agent_response = get_agent_response(SummaryAssistant, summary_prompt, knowledge_base=knowledge_base)
        
        # ç¡®ä¿æœ‰å¬å›æ–‡æœ¬æ®µæ˜¾ç¤º
        if not collected_knowledge_chunks:
            collected_knowledge_chunks = "å¤šæ™ºèƒ½ä½“æ¨¡å¼ï¼šå·²å®Œæˆå¼‚å¸¸è§£å†³æ–¹æ¡ˆæŸ¥è¯¢ï¼Œä½†æœªæ£€ç´¢åˆ°è¶³å¤Ÿç›¸å…³çš„å†…å®¹ã€‚å»ºè®®æä¾›æ›´è¯¦ç»†çš„èº«ä½“æ•°æ®æˆ–å’¨è¯¢ä¸“ä¸šå¥åº·é¡¾é—®ã€‚"
        
        return multi_agent_response, collected_knowledge_chunks
    
    except Exception as e:
        print(f"Multi-agent processing failed: {e}")
        # å…œåº•ç­–ç•¥ï¼Œå¦‚æœä¸Šè¿°ç¨‹åºè¿è¡Œå¤±è´¥ï¼Œåˆ™ç›´æ¥è°ƒç”¨ChatAssistant
        fallback_response = get_agent_response(ChatAssistant, query, knowledge_base=knowledge_base)
        return fallback_response, "å¤šæ™ºèƒ½ä½“æ¨¡å¼å‡ºé”™ï¼Œå·²åˆ‡æ¢åˆ°é€šç”¨é—®ç­”æ¨¡å¼"

# ==================== åŸæœ‰RAGå‡½æ•° ====================

def get_model_response(multi_modal_input,history,model,temperature,max_tokens,history_round,db_name,similarity_threshold,chunk_cnt):
    # prompt = multi_modal_input['text']
    prompt = history[-1][0]
    tmp_files = multi_modal_input['files']
    if os.path.exists(os.path.join("File",TMP_NAME)):
        db_name = TMP_NAME
    else:
        if tmp_files:
            create_tmp_kb(tmp_files)
            db_name = TMP_NAME
    # è·å–index
    print(f"prompt:{prompt},tmp_files:{tmp_files},db_name:{db_name}")
    try:
        dashscope_rerank = DashScopeRerank(
            top_n=chunk_cnt,
            return_documents=True,
            api_key="sk-51d30a5436ca433b8ff81e624a23dcac"
        )
        storage_context = StorageContext.from_defaults(
            persist_dir=os.path.join(DB_PATH,db_name)
        )
        index = load_index_from_storage(storage_context)
        print("indexè·å–å®Œæˆ")
        retriever_engine = index.as_retriever(
            similarity_top_k=20,
        )
        # è·å–chunk
        retrieve_chunk = retriever_engine.retrieve(prompt)
        print(f"åŸå§‹chunkä¸ºï¼š{retrieve_chunk}")
        try:
            results = dashscope_rerank.postprocess_nodes(retrieve_chunk, query_str=prompt)
            print(f"rerankæˆåŠŸï¼Œé‡æ’åçš„chunkä¸ºï¼š{results}")
        except:
            results = retrieve_chunk[:chunk_cnt]
            print(f"rerankå¤±è´¥ï¼Œchunkä¸ºï¼š{results}")
        chunk_text = ""
        chunk_show = ""
        for i in range(len(results)):
            if results[i].score >= similarity_threshold:
                chunk_text = chunk_text + f"## {i+1}:\n {results[i].text}\n"
                chunk_show = chunk_show + f"## {i+1}:\n {results[i].text}\nscore: {round(results[i].score,2)}\n"
        print(f"å·²è·å–chunkï¼š{chunk_text}")
        prompt_template = f"è¯·å‚è€ƒä»¥ä¸‹å†…å®¹ï¼š{chunk_text}ï¼Œä»¥åˆé€‚çš„è¯­æ°”å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼š{prompt}ã€‚å¦‚æœå‚è€ƒå†…å®¹ä¸­æœ‰å›¾ç‰‡é“¾æ¥ä¹Ÿè¯·ç›´æ¥è¿”å›ã€‚"
    except Exception as e:
        print(f"å¼‚å¸¸ä¿¡æ¯ï¼š{e}")
        prompt_template = prompt
        chunk_show = ""
    history[-1][-1] = ""
    client = OpenAI(
        api_key="sk-51d30a5436ca433b8ff81e624a23dcac",
        base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    )                
    system_message = {'role': 'system', 'content': 'You are a helpful assistant.'}
    messages = []
    history_round = min(len(history),history_round)
    for i in range(history_round):
        messages.append({'role': 'user', 'content': history[-history_round+i][0]})
        messages.append({'role': 'assistant', 'content': history[-history_round+i][1]})
    messages.append({'role': 'user', 'content': prompt_template})
    messages = [system_message] + messages
    completion = client.chat.completions.create(
        model=model,
        messages=messages,
        temperature=temperature,
        max_tokens=max_tokens,
        stream=True
        )
    assistant_response = ""
    for chunk in completion:
        assistant_response += chunk.choices[0].delta.content
        history[-1][-1] = assistant_response
        yield history,chunk_show

# ==================== ç»Ÿä¸€å“åº”å‡½æ•° ====================

def get_unified_response(multi_modal_input, history, mode, model, temperature, max_tokens, history_round, knowledge_base, similarity_threshold, chunk_cnt):
    """ç»Ÿä¸€çš„å“åº”å‡½æ•°ï¼Œæ”¯æŒRAGå’Œå¤šæ™ºèƒ½ä½“ä¸¤ç§æ¨¡å¼"""
    prompt = history[-1][0] if history else ""
    
    if mode == "multi_agent":
        # å¤šæ™ºèƒ½ä½“æ¨¡å¼
        try:
            response, knowledge_chunks = get_multi_agent_response_internal(prompt, knowledge_base)
            history[-1][-1] = response
            yield history, knowledge_chunks
        except Exception as e:
            print(f"å¤šæ™ºèƒ½ä½“æ¨¡å¼å¤±è´¥ï¼Œé™çº§åˆ°RAGæ¨¡å¼: {e}")
            # é™çº§åˆ°RAGæ¨¡å¼
            yield from get_model_response(multi_modal_input, history, model, temperature, max_tokens, history_round, knowledge_base, similarity_threshold, chunk_cnt)
    else:
        # RAGæ¨¡å¼
        yield from get_model_response(multi_modal_input, history, model, temperature, max_tokens, history_round, knowledge_base, similarity_threshold, chunk_cnt)
        
def test_body_analysis():
    """æµ‹è¯•èº«ä½“å¼‚å¸¸åˆ†æçš„å¤šæ™ºèƒ½ä½“æµç¨‹"""
    # ç¤ºä¾‹ç”¨æˆ·æ•°æ®
    user_body_data = {
        "mass_info":{
            "WT":{"l":25.8, "m":30.4, "h":35, "v":48.7, "status":3},
            "FFM":{"l":28.7, "m":31.9, "h":35.1, "v":4.9, "status":1},
            "TBW":{"l":37.285292814, "m":41.412983381000004, "h":45.540673948000006, "v":34.110146224000005, "status":1},
            "BMI":{"l":18.5, "m":22, "h":24, "v":23.4, "status":2},
            "PBF":{"l":10, "m":15, "h":20, "v":33.7, "status":3},
            "BMR":{"l":1432.4, "m":1591.6, "h":1750.8, "v":1413.1, "status":1},
            "WHR":{"l":0.8, "m":0.85, "h":0.9, "v":0.88, "status":2},
            "SM":{"l":28.440241599000004, "m":31.842184374000002, "h":35.289486386, "v":25.764046616, "status":1},
            "PROTEIN":{"l":9.979032140000001, "m":11.113013065, "h":12.24699399, "v":9.162565874, "status":1},
            "ICW":{"l":23.133210870000003, "m":25.718687379000002, "h":28.304163888, "v":21.092045205, "status":1},
            "ECW":{"l":14.152081944, "m":15.739655239000003, "h":17.327228534000003, "v":13.471693389, "status":1},
            "VAG":{"l":0.9, "h":10, "m":0, "v":9, "status":2}
        },
        "girth_info":{
            "left_calf":40.9, "right_calf":41.4, "neck":37.083999999999996,
            "waist":87.884, "hip":103.37800000000001, "left_upper_arm":28.194, "right_upper_arm":28.448
        },
        "eval_info":{
            "id":20985, "scan_id":"37123456789136-950b07ba-875a-41b7-8850-271bf5b79764",
            "high_low_shoulder":3.302, "head_slant":0, "head_forward":1.5,
            "left_leg_xo":179.5, "right_leg_xo":174.3, "pelvis_forward":176.5,
            "left_knee_check":183.6, "right_knee_check":175.9,
            "round_shoulder_left":7.7, "round_shoulder_right":19.6, "create_time":None
        },
        "eval_conclusion":{
            "head_slant":{"conclusion_key":"body-product.bsEval.headSlant.normal", "val":0},
            "high_low_shoulder":{"conclusion_key":"body-product.bsEval.highLowShoudler.left", "val":3.302},
            "head_forward":{"conclusion_key":"body-product.bsEval.headForward.head", "val":1.5},
            "round_shoulder_left":{"conclusion_key":"body-product.bsEval.roundShoulder.left", "val":7.7},
            "round_shoulder_right":{"conclusion_key":"body-product.bsEval.roundShoulder.right", "val":19.6},
            "is_new_math_tt":1
        },
        "shoulder_info":{
            "id":2192, "scan_id":"37123456789136-950b07ba-875a-41b7-8850-271bf5b79764",
            "result":1, "left_abduction":173.2, "right_abduction":181.1,
            "left_adduction":174.1, "right_adduction":171, "create_time":1724313842
        },
        "user_info":{"height":174, "age":30, "sex":1},
        "isForeign":"0", "unit":"imperial", "lang": "zh-CN"
    }
    

    
    
    # è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼ä¾›åˆ†æä½¿ç”¨
    query = f"è¯·åˆ†æä»¥ä¸‹èº«ä½“æ•°æ®å¹¶ç”Ÿæˆ1ä¸ªä½“æˆåˆ†å¼‚å¸¸å’Œæœ€å¤š4ä¸ªä½“æ€å¼‚å¸¸åˆ†æï¼š{json.dumps(user_body_data, ensure_ascii=False)}"
    
    # è°ƒç”¨å¤šæ™ºèƒ½ä½“åˆ†æ
    try:
        response, knowledge_chunks = get_multi_agent_response_internal(query, "å¼‚å¸¸2")
        print("=== å¤šæ™ºèƒ½ä½“åˆ†æç»“æœ ===")
        print(f"åˆ†æç»“æœï¼š{response}")
        #print("\n=== çŸ¥è¯†åº“å¬å›ä¿¡æ¯ ===")
        #print(knowledge_chunks)
        return response, knowledge_chunks
    except Exception as e:
        print(f"æµ‹è¯•å¤±è´¥ï¼š{e}")
        return None, None

if __name__ == "__main__":
    # è¿è¡Œæµ‹è¯•
    test_body_analysis()